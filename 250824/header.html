<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <style>
    .header-container { text-align: center; }
    .stage-button {
      font-size: 20px; margin: 3px; padding: 4px 4px; width: 82px;
      border: 1px solid #ced4da; border-radius: 8px; cursor: pointer;
      background-color: #f1f3f5; color: #495057;
      font-weight: 500; transition: all 0.2s ease;
    }
    .stage-button:disabled { cursor: not-allowed; opacity: 0.6; }
    .stage-button:not(:disabled):hover { border-color: #868e96; }
    .active {
      background-color: #339af0; color: white; border-color: #339af0;
    }
    .stage-success {
      background-color: #28a745; color: white; border-color: #28a745;
    }
  </style>
</head>
<body>
  <div class="header-container">
    <h1>EscapeRoom</h1>
    <div id="stage-buttons"></div>
  </div>

  <script>
    let currentStage = 1;
    const clearedStages = new Set();
    const availablePuzzles = [1,2,3,4,5,6,7,8,9,10];
    const hintUsage = {}; // { stage번호: 힌트 사용 최대값 }

    // 버튼 생성
    function renderStageButtons() {
      const container = document.getElementById("stage-buttons");
      container.innerHTML = "";
      availablePuzzles.forEach(stage => {
        const btn = document.createElement("button");
        btn.id = "btn" + stage;
        btn.className = "stage-button";
        btn.onclick = () => selectStage(stage);
        container.appendChild(btn);
        if (stage === 5) container.appendChild(document.createElement("br")); // 5단계 뒤 줄바꿈
      });
      updateButtons();
    }

    // 버튼 상태 및 텍스트 갱신
    function updateButtons() {
      availablePuzzles.forEach(stageNum => {
        const btn = document.getElementById("btn" + stageNum);
        if (!btn) return;

        btn.classList.remove("active", "stage-success");

        let label = stageNum + "단계";
        if (hintUsage[stageNum]) {
          label += `(${hintUsage[stageNum]})`;
        }
        btn.textContent = label;

        if (clearedStages.has(stageNum)) {
          btn.classList.add("stage-success");
        }
        btn.disabled = !clearedStages.has(stageNum) && stageNum > clearedStages.size + 1;
      });

      const currentBtn = document.getElementById("btn" + currentStage);
      if (currentBtn) {
        currentBtn.classList.remove("stage-success");
        currentBtn.classList.add("active");
        currentBtn.disabled = false;
      }
    }

    function selectStage(stage) {
      if (!availablePuzzles.includes(stage)) return;

      if (clearedStages.has(stage)) {
        // ✅ 마지막 단계(10단계)라면 success.html 로드
        if (stage === 10) {
          $("#puzzle").load("success.html");
        } else {
          $("#puzzle").load(`puzzle-${stage}.html`);
        }
        return; 
      }

      if (stage > clearedStages.size + 1) return;
      
      currentStage = stage;
      updateButtons();

      // ✅ 마지막 단계는 success.html 로드
      if (stage === 10) {
        $("#puzzle").load("success.html");
      } else {
        $("#puzzle").load(`puzzle-${stage}.html`);
      }
    }

    // "다음 단계" 버튼 클릭 시 동작 수정
    $(document).on('selectStage', function(event, data) {
      if (data?.stage === 10) {
        // 9단계의 "다음 단계" 버튼에서 10을 요청하면 puzzle-10.html을 로드
        $("#puzzle").load("puzzle-10.html");
        return;
      }
      if (data?.stage === 11) {
        // 10단계의 "다음 단계" 버튼에서 11을 요청하면 success.html을 로드
        $("#puzzle").load("success.html");
        return;
      }
      if (data?.stage) selectStage(data.stage);
    });

    // 이벤트 등록
    $(document).ready(function() {
      $(document).on('clearStage', function(event, data) {
        if (data?.stage) {
          clearedStages.add(data.stage);
          updateButtons();
        }
      });

      // selectStage 이벤트는 위에서 재정의됨

      // [수정된 부분] 힌트 사용 이벤트 처리 → 최대값 유지
      $(document).on('updateHint', function(event, data) {
        if (data && data.stage && typeof data.count === "number") {
          if (!hintUsage[data.stage] || data.count > hintUsage[data.stage]) {
            hintUsage[data.stage] = data.count;
            updateButtons();
          }
        }
      });

      renderStageButtons();
    });
  </script>
</body>
</html>

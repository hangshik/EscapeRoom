<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <style>
    .header-container { text-align: center; }
    .stage-button-container { display: inline-block; } /* 컨테이너 추가 */
    .wrong-attempts-container { display: inline-block; margin-left: 15px; font-size: 20px; font-weight: bold; color: #e03131; vertical-align: top; margin-top: 5px;} /* 오답 횟수 스타일 */
    .stage-button {
      font-size: 20px; margin: 3px; padding: 4px 4px; width: 110px;
      border: 1px solid #ced4da; border-radius: 8px; cursor: pointer;
      background-color: #f1f3f5; color: #495057;
      font-weight: 500; transition: all 0.2s ease;
    }
    .stage-button:disabled { cursor: not-allowed; opacity: 0.6; }
    .stage-button:not(:disabled):hover { border-color: #868e96; }
    .active {
      background-color: #339af0; color: white; border-color: #339af0;
    }
    .stage-success {
      background-color: #28a745; color: white; border-color: #28a745;
    }
  </style>
</head>
<body>
  <div class="header-container">
    <h1>EscapeRoom</h1>
    <div id="stage-buttons" class="stage-button-container"></div><br>
    <div id="total-wrong-attempts" class="wrong-attempts-container"></div>
  </div>

  <script>
    let currentStage = 1;
    const clearedStages = new Set();
    const availablePuzzles = [1,2,3,4,5,6,7,8,9,10];
    const hintUsage = {}; // { stage번호: 힌트 사용 최대값 }
    const wrongAttempts = {}; // { stage번호: 오답 횟수 }

    // 버튼 생성
    function renderStageButtons() {
      const container = document.getElementById("stage-buttons");
      container.innerHTML = "";
      availablePuzzles.forEach(stage => {
        const btn = document.createElement("button");
        btn.id = "btn" + stage;
        btn.className = "stage-button";
        btn.onclick = () => selectStage(stage);
        container.appendChild(btn);
        if (stage % 4 === 0) container.appendChild(document.createElement("br"));
      });
      updateButtons();
    }

    // 버튼 상태 및 텍스트 갱신
    function updateButtons() {
      availablePuzzles.forEach(stageNum => {
        const btn = document.getElementById("btn" + stageNum);
        if (!btn) return;

        btn.classList.remove("active", "stage-success");

        let label = stageNum + "단계";
        if (hintUsage[stageNum]) {
          label += `(${hintUsage[stageNum]})`;
        }
        // 개별 버튼의 오답 횟수 표시 제거
        btn.textContent = label;

        if (clearedStages.has(stageNum)) {
          btn.classList.add("stage-success");
        }
        btn.disabled = !clearedStages.has(stageNum) && stageNum > clearedStages.size + 1;
      });

      const currentBtn = document.getElementById("btn" + currentStage);
      if (currentBtn) {
        currentBtn.classList.remove("stage-success");
        currentBtn.classList.add("active");
        currentBtn.disabled = false;
      }
    }

    // 총 오답 횟수 갱신
    function updateTotalWrongAttempts() {
        const totalWrong = Object.values(wrongAttempts).reduce((sum, count) => sum + count, 0);
        const displayEl = document.getElementById("total-wrong-attempts");
        if (totalWrong > 0) {
            displayEl.textContent = `총 오답 횟수: ${totalWrong}`;
        } else {
            displayEl.textContent = "";
        }
    }

    function selectStage(stage) {
      if (!availablePuzzles.includes(stage)) return;

      if (clearedStages.has(stage)) {
        if (stage === 10) {
          $("#puzzle").load("success.html");
        } else {
          $("#puzzle").load(`puzzle-${stage}.html`);
        }
        return; 
      }

      if (stage > clearedStages.size + 1) return;
      
      currentStage = stage;
      updateButtons();

      if (stage === 11) {
        $("#puzzle").load("success.html");
      } else {
        $("#puzzle").load(`puzzle-${stage}.html`);
      }
    }

    $(document).on('selectStage', function(event, data) {
      if (data?.stage === 10) {
        $("#puzzle").load("puzzle-10.html");
        currentStage = 10;
        updateButtons();
        return;
      }
      if (data?.stage === 11) {
        $("#puzzle").load("success.html");
        currentStage = 11;
        updateButtons();
        return;
      }
      if (data?.stage) {
        selectStage(data.stage);
      }
    });

    // 이벤트 등록
    $(document).ready(function() {
      $(document).on('clearStage', function(event, data) {
        if (data?.stage) {
          clearedStages.add(data.stage);
          updateButtons();
        }
      });

      $(document).on('updateHint', function(event, data) {
        if (data && data.stage && typeof data.count === "number") {
          if (!hintUsage[data.stage] || data.count > hintUsage[data.stage]) {
            hintUsage[data.stage] = data.count;
            updateButtons();
          }
        }
      });

      // 오답 횟수 증가 이벤트
      $(document).on('wrongAnswer', function(event, data) {
        if (data && data.stage) {
          wrongAttempts[data.stage] = (wrongAttempts[data.stage] || 0) + 1;
          updateButtons(); // 버튼 상태는 계속 업데이트
          updateTotalWrongAttempts(); // 총 오답 횟수 업데이트
        }
      });

      renderStageButtons();
    });
  </script>
</body>

</html>

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CrazyHouse</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<style>
:root {
  --active: #007bff;
  --success: #28a745;
  --danger: #dc3545;
  --hint: #17a2b8;
  --bg: #f0f2f5;
  --card-bg: #ffffff;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  margin: 0;
  padding: 15px 10px; /* ëª¨ë°”ì¼ ì—¬ë°± ì¶•ì†Œ */
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow-x: hidden;
}

/* ë©”ì¸ ì»¨í…Œì´ë„ˆ ë°˜ì‘í˜• ì„¤ì • */
.container-fixed {
  width: 100%;
  max-width: 800px;
  background: var(--card-bg);
  border-radius: 20px;
  padding: 20px; /* ëª¨ë°”ì¼ íŒ¨ë”© ì¶•ì†Œ */
  box-shadow: 0 10px 25px rgba(0,0,0,0.05);
  margin-bottom: 20px;
}

h1 { 
  margin: 0 0 20px; 
  font-size: clamp(20px, 5vw, 32px); /* ë°˜ì‘í˜• í°íŠ¸ */
  text-align: center; 
  font-weight: 800; 
}

.quiz-question {
  font-size: clamp(18px, 4vw, 28px);
  font-weight: 700;
  text-align: center;
  margin-bottom: 15px;
  color: #444;
  word-break: keep-all; /* í•œê¸€ ì¤„ë°”ê¿ˆ ìµœì í™” */
}

/* ë‹¨ê³„ ë²„íŠ¼ ê·¸ë¦¬ë“œ ëª¨ë°”ì¼ ìµœì í™” */
.stage-button-container {
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: 8px; /* ê°„ê²© ì¶•ì†Œ */
  width: 100%;
}

.stage-button {
  width: 100%;
  padding: 12px 2px; /* í„°ì¹˜ ì˜ì—­ í™•ë³´ */
  border-radius: 10px;
  border: 1px solid #e9ecef;
  background: #f8f9fa;
  font-size: clamp(12px, 2.5vw, 18px);
  font-weight: 700;
  cursor: pointer;
  transition: 0.2s;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.stage-button.active { background: var(--active); color: #fff; border-color: var(--active); }
.stage-button.stage-success { background: var(--success); color: #fff; border-color: var(--success); }

.status-bar { 
  display: flex; 
  justify-content: flex-end; 
  margin-top: 15px; 
  gap: 8px; 
  flex-wrap: wrap; /* ë°°ì§€ê°€ ë„˜ì¹  ê²½ìš° ì¤„ë°”ê¿ˆ */
}

.badge { 
  padding: 6px 12px; 
  border-radius: 20px; 
  font-size: clamp(12px, 3vw, 16px); 
  font-weight: 700; 
  border: 1px solid; 
}
.wrong-badge { background: #fff5f5; color: var(--danger); border-color: #ffe3e3; }
.hint-badge { background: #e7faff; color: var(--hint); border-color: #bee5eb; display: none; }

.quiz-image { 
  width: 100%; 
  max-height: 50vh; /* ëª¨ë°”ì¼ì—ì„œ ì´ë¯¸ì§€ê°€ ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šê²Œ ë°©ì§€ */
  border-radius: 12px; 
  display: block; 
  margin: 0 auto; 
  cursor: pointer;
  background: #eee;
  object-fit: contain;
}

/* ì…ë ¥ ì˜ì—­ ëª¨ë°”ì¼ ë°°ì¹˜ */
.input-group { 
  margin: 20px 0; 
  display: flex; 
  justify-content: center; 
  gap: 10px; 
}
#answer { 
  flex: 1; 
  max-width: 180px; 
  font-size: 18px; /* ëª¨ë°”ì¼ ì…ë ¥ì°½ í™•ëŒ€ ë°©ì§€ ìµœì†Œ 16px ì´ìƒ */
  padding: 12px; 
  border-radius: 12px; 
  border: 2px solid #dee2e6; 
  text-align: center; 
  appearance: none; /* iOS ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
}

.btn-submit {
  padding: 12px 24px; 
  border-radius: 12px; 
  background: var(--active);
  color: #fff; 
  border: none; 
  font-size: 18px; 
  font-weight: 700; 
  cursor: pointer;
}

.btn-hint {
  padding: 10px 15px; 
  border-radius: 8px; 
  border: 1.5px solid #dee2e6;
  background: #fff; 
  font-size: 14px; 
  margin: 3px; 
  cursor: pointer;
}
.btn-hint.enabled { background: #e7f1ff; border-color: var(--active); color: var(--active); font-weight: bold; }

.hint-content {
  background: #f8f9fa; 
  padding: 15px; 
  border-radius: 12px;
  margin-top: 15px; 
  font-size: 16px; 
  border-left: 4px solid var(--active);
  line-height: 1.5;
}

/* ëª¨ë‹¬ ë° íŒì—… ìµœì í™” */
.success-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 10000;
  padding: 20px;
}
.success-modal { 
  background: #fff; 
  padding: 30px; 
  border-radius: 20px; 
  text-align: center; 
  width: 100%; 
  max-width: 350px; 
}

#final-success {
  position: fixed; inset: 0; background: #fff; z-index: 11000;
  display: flex; justify-content: center; align-items: center; cursor: pointer;
}
#final-success img { width: 100%; height: 100%; object-fit: contain; }

/* í° í™”ë©´(ë°ìŠ¤í¬íƒ‘) ëŒ€ì‘ */
@media (min-width: 800px) {
  .container-fixed { padding: 35px; }
  .stage-button { padding: 18px 5px; font-size: 18px; }
  #answer { font-size: 24px; max-width: 250px; }
  .btn-submit { font-size: 22px; }
}
</style>
</head>
<body>

<div class="container-fixed">
  <h1>CrazyHouse</h1>
  <div id="stage-buttons" class="stage-button-container"></div>
  <div class="status-bar">
    <div id="hint-count-badge" class="badge hint-badge">íŒíŠ¸ íšŸìˆ˜: <span id="total-hint-count">0</span></div>
    <div class="badge wrong-badge">ì˜¤ë‹µ íšŸìˆ˜: <span id="wrong-count">0</span></div>
  </div>
</div>

<div id="puzzle" class="container-fixed"></div>

<script>
// ì´ë¯¸ì§€ ìš°í´ë¦­ ë°©ì§€
document.addEventListener("contextmenu", e => e.preventDefault());

const puzzleData = [
  // {stage:1, question:"ì°¨ê°€ ì£¼ì°¨ëœ ê³³ì— ê°€ë ¤ì§„ ìˆ«ìëŠ”?", image:"p1.png", answer:"61", inputType:"number", hints:[{type:'text',content:'ê°œìˆ˜'},{type:'text',content:'ë™ê·¸ë¼ë¯¸ ê°œìˆ˜'}]},
  { stage: 1, image: "p1.png", question: "ì°¨ê°€ ì£¼ì¹˜ëœ ê³³ì— ê°€ë ¤ì§„ ìˆ«ìëŠ”?", answer: "61", inputType: "number", hints: [{type: 'text', content: 'ê±°ê¾¸ë¡œ'}] },
  { stage: 2, image: "p2.png", question: "ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”.", answer: ["COSMOS","cosmos"], inputType: "text", hints: [{type: 'text', content: 'ë§ˆë£»ë°”ë‹¥'},{type: 'text', content: 'ì˜ì–´'}] },
  { stage: 3, image: "p3.png", question: "ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.", answer: "6906", inputType: "number", hints: [{type: 'text', content: 'ì‹œê³„'}] },
  { stage: 4, image: "p4.png", question: "ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.",  answer: ["5119658", "5773652"], inputType: "number", hints: [{type: 'text', content: 'í‚¤íŒ¨ë“œ'}] },
  { stage: 5, image: "p5.png", question: "ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.", answer: "2056", inputType: "number", hints: [{type: 'text', content: 'ë””ì§€í„¸ ìˆ«ì'},{type: 'text', content: 'ìˆœì„œ'}] },
  { stage: 6, image: "p6.png", question: "ë²½ì— ê±¸ë ¤ìˆëŠ” ì‹œê³„ëŠ” ê³ ì¥ì´ ë‚˜ ë©ˆì¶°ìˆë‹¤. ìˆ«ìê°€ ì í˜€ ìˆì§€ ì•Šê³ , ë˜‘ë°”ë¡œ ê±¸ë ¤ ìˆëŠ” ê²ƒì´ ì•„ë‹ˆë‹¤. ì‹œì¹¨ê³¼ ë¶„ì¹¨ ì‚¬ì´ì˜ ê°ë„ëŠ” 105ë„ì¼ ë•Œ ì‹œê³„ëŠ” í˜„ì¬ ëª‡ ì‹œ ëª‡ ë¶„ì— ë©ˆì¶°ìˆëŠ” ê²ƒì¸ì§€ ì“°ì‹œì˜¤.(ì„¸ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.)", answer: ["230","930"], inputType: "number", hints: [{type: 'text', content: 'ì‹œê³„ ì „ì²´ëŠ” 360ë„, ê° ìˆ«ì ì‚¬ì´ì˜ ê°ë„ëŠ” 30ë„'}] },
  { stage: 7, image: "p7.png", question: "ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.", answer: "2118", inputType: "number", hints: [{type: 'text', content: 'ì˜ì–´'}, {type: 'text', content: 'ëŒ€ì¹­'}] },
  { stage: 8, image: "p8.png", question: "ì •ë‹µì„ ì…ë ¥í•˜ì‹œì˜¤.", answer: ["ESCAPE","Escape","escape"], inputType: "text", hints: [{type: 'text', content: 'ë‹¤ë¥¸ ëˆˆë†’ì´'},{type: 'text', content: 'ì˜ì–´'}] }
];

let currentStage = 1;
let totalWrongCount = 0;
let imageZoomOverlay = null;
const clearedStages = new Set();
const hintUsage = {};
const stageState = {};

function updateStatusBar() {
  const totalHints = Object.values(hintUsage).reduce((acc, curr) => acc + curr, 0);
  if (totalHints > 0) {
    $("#hint-count-badge").css("display", "inline-block");
    $("#total-hint-count").text(totalHints);
  } else {
    $("#hint-count-badge").hide();
  }
  $("#wrong-count").text(totalWrongCount);
}

function renderStageButtons() {
  const c = $("#stage-buttons").empty();
  puzzleData.forEach(p => {
    const h = hintUsage[p.stage] || 0;
    const label = h > 0 ? `${p.stage}ë‹¨ê³„(${h})` : `${p.stage}ë‹¨ê³„`;
    let cls = "stage-button";
    if (p.stage === currentStage) cls += " active";
    else if (clearedStages.has(p.stage)) cls += " stage-success";
    c.append(`<button class="${cls}" onclick="selectStage(${p.stage})">${label}</button>`);
  });
}

function loadPuzzle(stage) {
  const p = puzzleData.find(x => x.stage === stage);
  const saved = stageState[stage] || {};
  let hintBtns = "", hintDivs = "";

  p.hints.forEach((h, i) => {
    const used = (hintUsage[stage] || 0) >= i + 1;
    const enabled = i === 0 || (hintUsage[stage] || 0) >= i;
    hintBtns += `<button class="btn-hint ${enabled ? "enabled" : ""}" ${enabled ? "" : "disabled"} onclick="toggleHint(${i + 1})">íŒíŠ¸ ${i + 1}</button>`;
    if (used) {
      const content = h.type === "text" ? h.content : `<img src="${h.content}" class="quiz-image" style="min-height:auto; margin-top:10px;"
             onclick="toggleImageZoom(this.src)">`;
      hintDivs += `<div class="hint-content">${content}</div>`;
    }
  });

  $("#puzzle").html(`
    <div class="quiz-question">${p.question}</div>
    <img src="${p.image}" class="quiz-image" onclick="toggleImageZoom(this.src)" onerror="this.alt='ì´ë¯¸ì§€ ì—†ìŒ (${p.image})'">
    <div class="input-group">
      <input id="answer" type="${p.inputType}" value="${saved.answer || ""}" placeholder="ì •ë‹µ" onkeypress="if(event.keyCode==13) checkAnswer()">
      <button class="btn-submit" onclick="checkAnswer()">í™•ì¸</button>
    </div>
    <p id="result" style="font-weight:700; height:25px; margin:10px 0; font-size:18px; text-align:center;"></p>
    <div style="border-top:1.5px solid #eee; padding-top:20px; margin-top:15px;">${hintBtns}</div>
    ${hintDivs}
  `);
}

function checkAnswer() {
  const p = puzzleData.find(x => x.stage === currentStage);
  const v = $("#answer").val().trim();
  const ok = Array.isArray(p.answer) ? p.answer.includes(v) : v === p.answer;

  if (ok) {
    stageState[currentStage] = { answer: v, result: "ì •ë‹µ!" };
    clearedStages.add(currentStage);
    renderStageButtons();
    showSuccess();
  } else {
    totalWrongCount++;
    updateStatusBar();
    $("#result").css("color", "var(--danger)").text("í‹€ë ¸ìŠµë‹ˆë‹¤! ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”.");
  }
}

function showSuccess() {
  const modal = $(`
    <div class="success-overlay">
      <div class="success-modal">
        <h2 style="color:var(--success); margin-top:0;">ğŸ‰ ì •ë‹µ!</h2>
        <p style="font-size:18px;">ì°¸ ì˜í•˜ì…¨ìŠµë‹ˆë‹¤!</p>
        <button id="modalNextBtn" class="btn-submit" style="width:100%; margin-top:20px;">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
      </div>
    </div>
  `);
  $("body").append(modal);

  const closeAndNext = () => {
    $(".success-overlay").remove();
    nextAction();
    $(document).off("keydown", handleEnter);
  };

  const handleEnter = (e) => { if (e.key === "Enter") closeAndNext(); };
  $(document).on("keydown", handleEnter);
  $("#modalNextBtn").click(closeAndNext);
}

function nextAction() {
  if (clearedStages.size === puzzleData.length) {
    showFinalSuccess();
    return;
  }
  let nextStage = -1;
  for (let i = currentStage + 1; i <= puzzleData.length; i++) {
    if (!clearedStages.has(i)) { nextStage = i; break; }
  }
  if (nextStage === -1) {
    for (let i = 1; i <= puzzleData.length; i++) {
      if (!clearedStages.has(i)) { nextStage = i; break; }
    }
  }
  if (nextStage !== -1) selectStage(nextStage);
}

function showFinalSuccess() {
  const finalLayer = $(`
    <div id="final-success">
      <img src="success.png" alt="Clear!" onerror="this.style.display='none'; alert('ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë‘ í´ë¦¬ì–´í•˜ì…¨ìŠµë‹ˆë‹¤.')">
      <div style="position:absolute; bottom:15%; font-size:16px; color:#666; background:rgba(255,255,255,0.8); padding:5px 15px; border-radius:20px;">í™”ë©´ì„ í´ë¦­í•˜ì—¬ ëŒì•„ê°€ê¸°</div>
    </div>
  `);
  finalLayer.click(function() {
    $(this).fadeOut(300, function() { $(this).remove(); });
  });
  $("body").append(finalLayer);
}

function toggleImageZoom(src) {
  // ì´ë¯¸ ì—´ë ¤ ìˆìœ¼ë©´ ì œê±°
  if (imageZoomOverlay) {
    imageZoomOverlay.remove();
    imageZoomOverlay = null;
  }

  imageZoomOverlay = $(`
    <div id="image-zoom-overlay"
         style="position:fixed;inset:0;background:rgba(0,0,0,0.95);
         z-index:20000;display:flex;justify-content:center;
         align-items:center;cursor:zoom-out;padding:10px;">
      <img src="${src}" style="max-width:100%;max-height:100%;object-fit:contain;">
    </div>
  `);

  // í´ë¦­ ì‹œ ë‹«ê¸°
  imageZoomOverlay.on("click", closeImageZoom);

  $("body").append(imageZoomOverlay);
}

function closeImageZoom() {
  if (imageZoomOverlay) {
    imageZoomOverlay.remove();
    imageZoomOverlay = null;
  }
}

$(document).on("keydown", function (e) {
  if (e.key === "Escape") {
    closeImageZoom();
  }
});

function toggleHint(n) {
  hintUsage[currentStage] = Math.max(hintUsage[currentStage] || 0, n);
  updateStatusBar();
  renderStageButtons();
  loadPuzzle(currentStage);
}

function selectStage(s) {
  currentStage = s;
  loadPuzzle(s);
  renderStageButtons();
  window.scrollTo({ top: 0, behavior: 'smooth' }); // ë‹¨ê³„ ì´ë™ ì‹œ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
}

$(document).ready(() => {
  updateStatusBar();
  renderStageButtons();
  selectStage(1);
});
</script>

</body>
</html>